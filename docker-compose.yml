services:
    traefik:
        image: traefik:v3.6
        container_name: paas-proxy
        command:
            - '--providers.docker=true'
            - '--providers.docker.exposedbydefault=false'
            - '--providers.docker.constraints=Label(`paas.type`, `user-app`)'
            - '--providers.docker.defaultRule=Host(`{{ index .Labels "paas.domain" }}`)'
            - '--providers.docker.network=${APP_NETWORK:-paas-app}'
            - '--providers.file.directory=/traefik-dynamic'
            - '--providers.file.watch=true'
            # HTTP: Let's Encrypt HTTP-01 challenge 수신 및 HTTPS로 리다이렉트
            - '--entrypoints.web.address=:80'
            - '--entrypoints.web.http.redirections.entrypoint.to=websecure'
            - '--entrypoints.web.http.redirections.entrypoint.scheme=https'
            # HTTPS
            - '--entrypoints.websecure.address=:443'
            # Let's Encrypt ACME (DNS-01 challenge via Cloudflare)
            - '--certificatesresolvers.letsencrypt.acme.dnschallenge=true'
            - '--certificatesresolvers.letsencrypt.acme.dnschallenge.provider=cloudflare'
            - '--certificatesresolvers.letsencrypt.acme.dnschallenge.resolvers=1.1.1.1:53,8.8.8.8:53'
            - '--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL}'
            - '--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json'
        environment:
            - CF_DNS_API_TOKEN=${CF_DNS_API_TOKEN}
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - ./portal-data/traefik-dynamic:/traefik-dynamic:ro
            - ./portal-data/letsencrypt:/letsencrypt
        networks:
            #            - proxy
            - paas-app
        restart: unless-stopped

    portal:
        build:
            context: .
            dockerfile_inline: |
                FROM node:22-alpine
                RUN apk add --no-cache bash git docker-cli docker-cli-compose docker-cli-buildx
                WORKDIR ${PAAS_ROOT:-/paas}/portal
        image: paas-portal:local
        container_name: paas-portal
        working_dir: ${PAAS_ROOT:-/paas}/portal
        # If .env is missing, copy .env.example to bootstrap local runtime config.
        # start/dev is selected by RUN_MODE (development -> dev, otherwise start).
        command: sh -c "if [ ! -f ${PAAS_ROOT:-/paas}/.env ] && [ -f ${PAAS_ROOT:-/paas}/.env.example ]; then cp ${PAAS_ROOT:-/paas}/.env.example ${PAAS_ROOT:-/paas}/.env; fi; npm ci && if [ \"$$RUN_MODE\" = \"development\" ]; then npm run dev; else npm run start; fi"
        restart: ${DEFAULT_RESTART_POLICY:-unless-stopped}
        init: true
        ports:
            - '${PORTAL_PORT:-3000}:${PORTAL_PORT:-3000}'
        environment:
            - PAAS_HOST_ROOT=${PWD}
        volumes:
            - './:${PAAS_ROOT:-/paas}'
            - 'portal_node_modules:${PAAS_ROOT:-/paas}/portal/node_modules'
            - /var/run/docker.sock:/var/run/docker.sock
#        networks:
#            - proxy

networks:
    #    proxy:
    #        name: proxy
    paas-app:
        external: true
        name: ${APP_NETWORK:-paas-app}

volumes:
    portal_node_modules:
